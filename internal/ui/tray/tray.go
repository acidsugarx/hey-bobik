package tray

import (
	"github.com/getlantern/systray"
)

// State represents the current visual state of the tray icon.
type State int

const (
	StateIdle      State = iota
	StateListening
	StateThinking
)

// Manager handles the system tray icon and menu.
type Manager struct {
	onExit func()
}

// New creates a new tray manager.
func New(onExit func()) *Manager {
	return &Manager{
		onExit: onExit,
	}
}

// Run initializes and starts the system tray loop.
// This must be called on the main thread.
func (m *Manager) Run() {
	systray.Run(m.onReady, m.onExit)
}

func (m *Manager) onReady() {
	systray.SetTitle("Bobik")
	systray.SetTooltip("Bobik: Linux Voice Agent")
	
	// Set default icon (Idle)
	systray.SetIcon(iconIdle)

	mQuit := systray.AddMenuItem("Quit", "Quit Bobik")
	
	go func() {
		<-mQuit.ClickedCh
		systray.Quit()
	}()
}

// SetState updates the tray icon based on the provided state.
func (m *Manager) SetState(state State) {
	switch state {
	case StateIdle:
		systray.SetIcon(iconIdle)
	case StateListening:
		systray.SetIcon(iconListening)
	case StateThinking:
		systray.SetIcon(iconThinking)
	}
}

// 16x16 solid color PNGs
var iconIdle = []byte{
	0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, 0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x91, 0x68,
	0x36, 0x00, 0x00, 0x00, 0x11, 0x49, 0x44, 0x41, 0x54, 0x08, 0xd7, 0x63, 0xa0, 0xa0, 0xa0, 0xa0,
	0x60, 0x00, 0x00, 0x00, 0x30, 0x00, 0x01, 0xc2, 0x20, 0x50, 0x92, 0x00, 0x00, 0x00, 0x00, 0x49,
	0x45, 0x4e, 0x44, 0xae, 0x42, 0x60, 0x82,
}

var iconListening = []byte{
	0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, 0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x91, 0x68,
	0x36, 0x00, 0x00, 0x00, 0x11, 0x49, 0x44, 0x41, 0x54, 0x08, 0xd7, 0x63, 0x60, 0xf8, 0x60, 0x60,
	0x60, 0x00, 0x00, 0x00, 0x30, 0x00, 0x01, 0x02, 0xaf, 0x16, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x49,
	0x45, 0x4e, 0x44, 0xae, 0x42, 0x60, 0x82,
}

var iconThinking = []byte{
	0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, 0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x91, 0x68,
	0x36, 0x00, 0x00, 0x00, 0x11, 0x49, 0x44, 0x41, 0x54, 0x08, 0xd7, 0x63, 0x60, 0x60, 0xf8, 0x60,
	0x60, 0x00, 0x00, 0x00, 0x30, 0x00, 0x01, 0x02, 0xaf, 0x16, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x49,
	0x45, 0x4e, 0x44, 0xae, 0x42, 0x60, 0x82,
}
